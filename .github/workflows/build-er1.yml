name: Build ER1 (ImmortalWrt + iStoreOS feeds + NSS)

on:
  workflow_dispatch:
    inputs:
      upload_artifacts:
        description: "Upload build artifacts"
        required: false
        default: "true"
      keep_dl_cache:
        description: "Cache dl directory (faster rebuilds)"
        required: false
        default: "true"

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: read

    env:
      # 你仓库里放的配置文件名
      CONFIG_FILE: er1.config
      # 让 OpenWrt 使用 ccache
      USE_CCACHE: "1"
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      # 统一时区（不影响结果，只是日志更直观）
      TZ: Asia/Shanghai

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init system deps
        run: |
          sudo apt update
          sudo apt install -y --no-install-recommends \
            build-essential clang flex bison g++ gawk gcc-multilib \
            gettext git libncurses5-dev libssl-dev python3 python3-distutils \
            rsync unzip zlib1g-dev file wget ca-certificates \
            ccache jq time
          sudo timedatectl set-timezone "$TZ" || true

      - name: Show build info
        run: |
          echo "Runner: $(uname -a)"
          echo "CPU: $(nproc)"
          df -h
          free -h

      # ccache：缓存编译产物（强烈建议开）
      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-${{ runner.os }}-${{ github.ref_name }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ github.ref_name }}-
            ccache-${{ runner.os }}-

      # dl：缓存源码下载（可选，通常很有用）
      - name: Restore dl cache
        if: ${{ inputs.keep_dl_cache == 'true' }}
        uses: actions/cache@v4
        with:
          path: dl
          key: dl-${{ runner.os }}-${{ github.ref_name }}-${{ github.sha }}
          restore-keys: |
            dl-${{ runner.os }}-${{ github.ref_name }}-
            dl-${{ runner.os }}-

      - name: Update base feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 你前面说 diy.sh 用 iStoreOS 源：这里直接调用
      - name: Add iStoreOS feeds (diy.sh)
        run: |
          test -f diy.sh || (echo "ERROR: diy.sh not found in repo root" && exit 1)
          chmod +x diy.sh
          ./diy.sh

      - name: Load config & defconfig
        run: |
          test -f "$CONFIG_FILE" || (echo "ERROR: $CONFIG_FILE not found in repo root" && exit 1)
          cp "$CONFIG_FILE" .config
          make defconfig
          echo "==== .config (target snippet) ===="
          grep -E "CONFIG_TARGET_|CONFIG_PACKAGE_luci|CONFIG_PACKAGE_luci-app" .config | head -n 200 || true

      - name: Download sources
        run: |
          mkdir -p dl
          make download -j"$(nproc)" V=s
          # 清理过小的下载残片（常见于网络中断）
          find dl -type f -size -102
