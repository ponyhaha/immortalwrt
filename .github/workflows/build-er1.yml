name: Build ER1 (ImmortalWrt + iStoreOS + NSS)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      TZ: Asia/Shanghai
      CONFIG_FILE: er1.config
      USE_CCACHE: "1"
      CCACHE_DIR: ${{ github.workspace }}/.ccache

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init dependencies
        run: |
          sudo apt update
          sudo apt install -y --no-install-recommends \
            build-essential clang flex bison g++ gawk gcc-multilib \
            gettext git libncurses5-dev libssl-dev python3 python3-distutils \
            rsync unzip zlib1g-dev file wget ca-certificates \
            ccache jq time
          sudo timedatectl set-timezone "$TZ" || true
          echo "CPU: $(nproc)"
          df -h

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-${{ runner.os }}-${{ github.ref_name }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ github.ref_name }}-
            ccache-${{ runner.os }}-

      - name: Restore dl cache
        uses: actions/cache@v4
        with:
          path: dl
          key: dl-${{ runner.os }}-${{ github.ref_name }}-${{ github.sha }}
          restore-keys: |
            dl-${{ runner.os }}-${{ github.ref_name }}-
            dl-${{ runner.os }}-

      - name: Update base feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Apply iStoreOS feeds (diy.sh)
        run: |
          test -f diy.sh || (echo "ERROR: diy.sh not found in repo root" && exit 1)
          chmod +x diy.sh
          ./diy.sh

      - name: Load config (er1.config) and defconfig
        run: |
          test -f "$CONFIG_FILE" || (echo "ERROR: $CONFIG_FILE not found in repo root" && exit 1)
          cp "$CONFIG_FILE" .config
          make defconfig
          echo "==== Target check ===="
          grep -E "CONFIG_TARGET_|CONFIG_TARGET.*DEVICE" .config | head -n 200 || true

      - name: Download sources
        run: |
          mkdir -p dl
          make download -j"$(nproc)" V=s
          find dl -type f -size -1024c -print -delete || true

      - name: Build firmware
        run: |
          ccache -z || true
          time make -j"$(nproc)" V=s
          ccache -s || true

      - name: List outputs
        run: |
          echo "==== bin/targets ===="
          ls -lah bin/targets || true
          echo "==== firmware candidates ===="
          find bin/targets -maxdepth 6 -type f \( \
            -name "*factory*.bin" -o -name "*sysupgrade*.bin" -o -name "*initramfs*.bin" -o \
            -name "*.manifest" -o -name "*.buildinfo" -o -name "*.sha256sums" \
          \) -print || true

      - name: Upload artifacts (firmware)
        uses: actions/upload-artifact@v4
        with:
          name: ER1-ImmortalWrt
          path: |
            bin/targets/**/*
            .config
          if-no-files-found: error
