name: Build NSS 固件

on:
  workflow_dispatch:          # ← 必须有这个，页面才会出现 Run workflow
    inputs:
      target:
        description: '目标芯片'
        required: true
        default: 'ipq60xx'
      subtarget:
        description: '子目标'
        required: true
        default: 'generic'
      profile:
        description: '机型'
        required: true
        default: 'jdcloud_re-cs-07'
      enable_nss:
        description: '启用NSS硬件加速'
        required: true
        default: 'true'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install packages
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk \
            gettext git java-propose-classpath libelf-dev libncurses5-dev \
            libncursesw5-dev libssl-dev python python2.7-dev python3 unzip wget \
            python3-distutils python3-setuptools python3-dev rsync subversion \
            swig time xsltproc zlib1g-dev

      - name: Init & feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Configure NSS & Plugins
        if: github.event.inputs.enable_nss == 'true'
        run: |
          # NSS 硬件加速
          echo "CONFIG_PACKAGE_kmod-nss-drv=y" >> .config
          echo "CONFIG_PACKAGE_kmod-nss-ecm=y" >> .config
          echo "CONFIG_PACKAGE_kmod-nss-ifb=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-nss=y" >> .config
          echo "CONFIG_PACKAGE_NSS_DRV_ENABLE=y" >> .config

          # 你之前列出的全部插件
          echo "CONFIG_PACKAGE_luci-app-adguardhome=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-autoreboot=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-diskman=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-easytier=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-firewall=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-istorex=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-lucky=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-mosdns=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-oaf=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-package-manager=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-passwall=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-pbr=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-quickfile=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-quickstart=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-samba4=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-smartdns=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-sqm=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-store=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-ttyd=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-vlmcsd=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-wol=y" >> .config

          # 常用工具链
          echo "CONFIG_PACKAGE_luci=y" >> .config
          echo "CONFIG_PACKAGE_luci-base=y" >> .config
          echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> .config
          echo "CONFIG_PACKAGE_curl=y" >> .config
          echo "CONFIG_PACKAGE_htop=y" >> .config
          echo "CONFIG_PACKAGE_nano=y" >> .config
          echo "CONFIG_PACKAGE_screen=y" >> .config
          echo "CONFIG_PACKAGE_wget-ssl=y" >> .config
          echo "CONFIG_PACKAGE_bash=y" >> .config
          echo "CONFIG_PACKAGE_coreutils-base64=y" >> .config
          echo "CONFIG_PACKAGE_kmod-tun=y" >> .config
          echo "CONFIG_PACKAGE_kmod-inet-diag=y" >> .config
          echo "CONFIG_PACKAGE_ca-bundle=y" >> .config
          echo "CONFIG_PACKAGE_ca-certificates=y" >> .config

          # 大内核 512 MB
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=512" >> .config

      - name: Download & Build
        run: |
          make download -j8
          make -j$(nproc) || make -j1 V=s

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-nss-bin
          path: bin/targets/*/*/*sysupgrade.bin
